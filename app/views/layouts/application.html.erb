<!DOCTYPE html>
<html>
  <head>
    <title>CU-BB</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <%# 
      这是【必须】的背景图样式
    %>
    <style>
      body:not(.login-page) {
        /* 1. 70% 不透明度的白色遮罩 (为了易读性) */
        background-image: linear-gradient(rgba(255, 255, 255, 0.70), rgba(255, 255, 255, 0.70)),
                          
        /* 2. 你的背景图 (使用 ERB 助手) */
                          url('<%= asset_path 'backgrounds/columbia_butler_day.jpg' %>'); 

        background-size: cover;
        background-position: center center;
        background-attachment: fixed;
        background-repeat: no-repeat;
      }
    </style>
  </head>

  <body class="<%= yield(:body_class) || "" %>">

    <%# --- 主页 (已登录) Header --- %>
    <% unless content_for?(:body_class) && yield(:body_class) == 'login-page' %>
      
      <header class="login-header">
        
        <%# Logo 链接 (带 onclick 确认) %>
        <%
          logo_link_options = { class: "header-logo-link" }
          if controller_name == 'posts' && action_name == 'new'
            logo_link_options[:onclick] = "return confirm('Are you sure you want to cancel? Any unsaved changes will be lost.');"
          end
        %>
        
        <%= link_to posts_path, logo_link_options do %>
          <div class="header-logo-group">
            <%= image_tag 'logos/cubb_owl.jpg', alt: 'CU BlueBoard Logo', class: 'logo-owl' %>
            
            <%# 
              !! ------------------------------ !!
              !!    这是【已修复】的 HTML 语法    !!
              !! ------------------------------ !!
              (class. 已经改回了 class=)
            %>
            <div class="logo-text">
              <span class="logo-main-text">CU BlueBoard</span>
              <span class="logo-sub-text">Columbia & Barnard</span>
            </div>
          </div>
        <% end %>
        
        <%# --- 2. 居中的 Flash 消息 --- %>
        <div class="header-flash-container">
          <% if notice.present? %>
            <div class="header-flash flash-notice"><%= notice %></div>
          <% end %>
          <% if alert.present? %>
            <div class="header-flash flash-alert"><%= alert %></div>
          <% end %>
        </div>

        <%# --- 3. 右侧 Nav --- %>
        <nav class="header-nav">
          <a href="#">My threads</a>
          <%= button_to 'Logout', destroy_user_session_path, 
                        method: :delete, 
                        data: { turbo: "false" },
                        class: "nav-logout-button" %>
        </nav>
      </header>

      <%# --- 主内容容器 --- %>
      <main class="app-main-content">
        <%= yield %>
      </main>

    <%# --- 登录页 (已登出) --- %>
    <% else %>
      <%= yield %>
    <% end %>

    <%# 
      !! -------------------------------- !!
      !!      这是【已清理】的 JavaScript     !!
      !! -------------------------------- !!
      (评论切换功能现在由 Stimulus controller 处理,
       所以这里只保留 Flash 和 Textarea 逻辑)
    %>
    <script>
      function setupPageScripts() {
        
        // --- 1. Flash 消息淡出逻辑 ---
        const flashElements = document.querySelectorAll(".header-flash");
        if (flashElements.length > 0) {
          flashElements.forEach(function(flashElement) {
            setTimeout(() => {
              flashElement.classList.add("fade-out");
              setTimeout(() => {
                flashElement.remove();
              }, 500); 
            }, 3000); 
          });
        }

        // --- 2. 自动生长的 Textarea ---
        const textareas = document.querySelectorAll(".form-textarea");
        function autoResizeTextarea(textarea) {
          if (textarea) { 
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
          }
        }
        textareas.forEach(textarea => {
          textarea.addEventListener('input', () => {
            autoResizeTextarea(textarea);
          });
          autoResizeTextarea(textarea);
        });
      }
      // 监听 Turbo 页面加载
      document.addEventListener("turbo:load", setupPageScripts);

      // (评论切换 JS 已被移除，由 Stimulus 接管)
    </script>
  </body>
</html>