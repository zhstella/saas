<%#
  Post detail page: displays question, all answers, and anonymity/identity reveal features
%>

<div class="main-content-container" data-controller="post-show">

  <%# --- Post title and author information --- %>
  <h2 class="page-title"><%= @post.title %></h2>
  <div class="post-meta">
    <span class="post-author">
      Posted by: <strong><%= display_author(@post.user, context: @post) %></strong>
    </span>
    <span class="post-time"><%= time_ago_in_words(@post.created_at) %> ago</span>
  </div>

  <% if @post.expires_at.present? %>
    <p class="identity-badge">Expires <%= time_ago_in_words(@post.expires_at) %> from now</p>
  <% end %>

  <div class="post-card-meta">
    <span class="meta-chip">Topic: <%= @post.topic&.name %></span>
    <span class="meta-chip">Status: <%= @post.status.humanize %></span>
    <% if @post.school.present? %>
      <span class="meta-chip">School: <%= @post.school %></span>
    <% end %>
    <% if @post.course_code.present? %>
      <span class="meta-chip">Course: <%= @post.course_code %></span>
    <% end %>
  </div>

  <% if @post.tags.any? %>
    <div class="post-card-tags">
      <% @post.tags.each do |tag| %>
        <span class="tag-chip readonly"><%= tag.name %></span>
      <% end %>
    </div>
  <% end %>

  <% if @post.locked? %>
    <p class="identity-badge">Thread locked after accepting an answer.</p>
    <% if @post.user == current_user %>
      <%= button_to 'Reopen Thread',
                    unlock_post_path(@post),
                    method: :patch,
                    class: 'form-submit-button identity-button',
                    data: { turbo_confirm: 'Reopen this thread and allow new answers?' } %>
    <% end %>
  <% end %>

  <% if current_user == @post.user && !@post.show_real_identity? %>
    <div class="identity-controls">
      <%= button_to "Reveal My Identity",
                    reveal_identity_post_path(@post),
                    method: :patch,
                    class: "form-submit-button identity-button",
                    data: { turbo_confirm: "Reveal your real identity on this thread?" } %>
    </div>
  <% elsif @post.show_real_identity? %>
    <p class="identity-badge">Author chose to reveal their identity.</p>
  <% end %>

  <%# --- Post body with conditional rendering for redacted content --- %>
  <% if @post.redacted? || @post.partial? %>
    <% if @post.user == current_user %>
      <%# Author view: Warning + original content visible %>
      <div class="alert alert-warning">
        <h4>Content Flagged</h4>
        <p>Your post has been flagged for review.</p>
        <% if @post.redacted_reason.present? %>
          <p><strong>Reason:</strong> <%= @post.redacted_reason.humanize %></p>
        <% end %>
      </div>
      <div class="post-body">
        <%= @post.redacted_body || @post.body %>
      </div>
    <% elsif current_user&.can_moderate? %>
      <%# Moderator view: Full content + moderation panel %>
      <div class="moderator-panel alert alert-info">
        <h4>Moderator View</h4>
        <p><strong>Redaction State:</strong> <%= @post.redaction_state.humanize %></p>
        <% if @post.redacted_reason.present? %>
          <p><strong>Reason:</strong> <%= @post.redacted_reason.humanize %></p>
        <% end %>
        <% if @post.redacted_by.present? %>
          <p><strong>Redacted by:</strong> <%= @post.redacted_by.email %></p>
        <% end %>
        <div class="moderator-actions">
          <%= button_to "Restore Post", unredact_moderation_post_path(@post),
                        method: :patch,
                        class: "form-submit-button" %>
        </div>
      </div>
      <div class="post-body">
        <%= @post.redacted_body || @post.body %>
      </div>
    <% else %>
      <%# General users: Placeholder message %>
      <div class="alert alert-info">
        <p>This post is currently under review for content policy violations.</p>
      </div>
    <% end %>
  <% else %>
    <%# Normal content display %>
    <div class="post-body">
      <%= @post.body %>
    </div>
  <% end %>

  <%# --- Post actions (like / answer button) --- %>
  <div class="post-actions">

    <div class="post-actions-left">
      <% if user_signed_in? %>
        <% if @post.liked_by?(current_user) %>
          <%= button_to "Unlike (üëç #{@post.likes.count})",
                        post_like_path(@post, @post.find_like_by(current_user)),
                        method: :delete,
                        class: "form-cancel-button" %>
        <% else %>
          <%= button_to "Like (üëç #{@post.likes.count})",
                        post_likes_path(@post),
                        method: :post,
                        class: "form-cancel-button" %>
        <% end %>
      <% else %>
        <span class="form-cancel-button disabled">üëç <%= @post.likes.count %></span>
      <% end %>

      <%= link_to "Answers (#{ @answers.count })", "#",
                  class: "form-cancel-button",
                  data: { action: "click->post-show#toggleAnswerForm" } %>
    </div>

    <% if @post.user == current_user %>
      <div class="post-owner-actions">
        <%= link_to "Edit Post", edit_post_path(@post), class: "form-secondary-button" %>
        <%= button_to "Delete This Post", @post,
                    method: :delete,
                    class: "btn-destructive",
                    data: { turbo_confirm: "Are you sure..." } %>
      </div>
    <% end %>

    <%# Moderator actions %>
    <% if current_user&.can_moderate? && !@post.redacted? %>
      <div class="moderator-actions">
        <%= button_to "Redact Post",
                      redact_moderation_post_path(@post),
                      method: :patch,
                      class: "btn-destructive",
                      form: { data: { turbo_frame: "_top" } },
                      params: { reason: 'policy_violation', state: 'redacted' },
                      data: { turbo_confirm: "Redact this post for policy violations?" } %>
      </div>
    <% end %>
  </div>

  <hr class="section-divider">

  <%# --- Answer form --- %>
  <div data-post-show-target="answerForm">
    <% if @post.locked? %>
      <p class="identity-badge">This thread is locked. No new answers can be added.</p>
    <% else %>
      <h3 class="comments-title">Share Your Answer</h3>

      <%= form_with(model: [@post, @answer]) do |form| %>
        <% if @answer.errors.any? %>
          <div class="form-errors">
            <% @answer.errors.full_messages.each do |message| %>
              <p class="error-message"><%= message %></p>
            <% end %>
          </div>
        <% end %>
        <div class="form-field">
          <%= form.label :body, "Answer Content", class: "form-label" %>
          <%= form.text_area :body, class: "form-textarea", rows: 4, placeholder: "Share your guidance..." %>
        </div>
        <div class="form-actions">
          <%= form.submit "Submit Answer", class: "form-submit-button" %>
        </div>
      <% end %>
    <% end %>

    <hr class="section-divider">
  </div>

  <%# --- Answer list --- %>
  <h3 class="comments-title">Answers (<%= @answers.count %>)</h3>

  <div class="comments-list-container" id="answers">
    <% @answers.each do |answer| %>
      <% next unless answer.persisted? %>
      <% accepted = (@post.accepted_answer_id == answer.id) %>
      <div class="comment-card <%= 'accepted-answer' if accepted %>">

        <div class="comment-meta">
          <span class="comment-author">
            <strong><%= display_author(answer.user, context: answer) %></strong>
          </span>
          <span class="comment-time">
            <% if answer.created_at.present? %>
              <%= time_ago_in_words(answer.created_at) %> ago
            <% else %>
              just now
            <% end %>
          </span>
          <% if accepted %>
            <span class="identity-badge">Accepted answer</span>
          <% end %>
        </div>

        <%# Answer body with conditional rendering for redacted content %>
        <% if answer.redacted? || answer.partial? %>
          <% if answer.user == current_user %>
            <%# Author view: Warning + original content %>
            <div class="alert alert-warning">
              <p><strong>Your answer was flagged.</strong></p>
              <% if answer.redacted_reason.present? %>
                <p><strong>Reason:</strong> <%= answer.redacted_reason.humanize %></p>
              <% end %>
            </div>
            <div class="comment-body">
              <%= answer.redacted_body || answer.body %>
            </div>
          <% elsif current_user&.can_moderate? %>
            <%# Moderator view %>
            <div class="moderator-panel alert alert-info" style="font-size: 0.9em; padding: 0.5em;">
              <p><strong>Moderator:</strong> Redacted (<%= answer.redaction_state %>)</p>
              <%= button_to "Restore", unredact_moderation_answer_path(answer),
                            method: :patch,
                            class: "form-secondary-button",
                            style: "font-size: 0.85em; padding: 0.3em 0.6em;" %>
            </div>
            <div class="comment-body">
              <%= answer.redacted_body || answer.body %>
            </div>
          <% else %>
            <%# General users: Placeholder %>
            <div class="comment-body alert alert-info">
              <p>This answer is currently under review for content policy violations.</p>
            </div>
          <% end %>
        <% else %>
          <%# Normal content %>
          <div class="comment-body">
            <%= answer.body %>
          </div>
        <% end %>

        <div class="comment-actions">
          <% if @post.user == current_user && !@post.locked? %>
            <%= button_to "Accept Answer",
                          accept_post_answer_path(@post, answer),
                          method: :patch,
                          class: "comment-reveal-button",
                          data: { turbo_confirm: "Accept this answer and lock the thread?" } %>
          <% elsif accepted && @post.user == current_user %>
            <span class="identity-badge">This answer is locked in.</span>
          <% end %>

          <% if answer.user == current_user %>
            <%= link_to "Edit Answer", edit_post_answer_path(@post, answer),
                        class: "comment-reveal-button" %>
            <%= button_to "Delete Answer", [@post, answer],
                        method: :delete,
                        class: "comment-delete-link",
                        data: { turbo_confirm: "Are you sure?" } %>
            <% if answer.show_real_identity? %>
              <span class="identity-badge">Answerer revealed their identity.</span>
            <% else %>
              <%= button_to "Reveal My Identity",
                            reveal_identity_post_answer_path(@post, answer),
                            method: :patch,
                            class: "comment-reveal-button",
                            data: { turbo_confirm: "Reveal your identity on this answer?" } %>
            <% end %>
          <% elsif answer.show_real_identity? %>
            <span class="identity-badge">Answerer revealed their identity.</span>
          <% end %>

          <%# Moderator actions for answers %>
          <% if current_user&.can_moderate? && !answer.redacted? %>
            <%= button_to "Redact Answer",
                          redact_moderation_answer_path(answer),
                          method: :patch,
                          class: "comment-delete-link",
                          params: { reason: 'policy_violation', state: 'redacted' },
                          data: { turbo_confirm: "Redact this answer for policy violations?" } %>
          <% end %>
        </div>

        <% if answer.answer_comments.any? %>
          <div class="answer-comments">
            <% answer.answer_comments.order(created_at: :asc).each do |comment| %>
              <div class="answer-comment">
                <span class="comment-author"><%= display_author(comment.user, context: comment) %></span>
                <span class="comment-time"><%= time_ago_in_words(comment.created_at) %> ago</span>
                <p><%= comment.body %></p>
                <% if comment.user == current_user %>
                  <%= button_to 'Delete', post_answer_comment_path(@post, answer, comment),
                                method: :delete,
                                class: 'comment-delete-link',
                                data: { turbo_confirm: 'Delete this comment?' } %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="answer-comment-form">
          <%= form_with(model: AnswerComment.new, url: post_answer_comments_path(@post, answer)) do |form| %>
            <div class="form-field">
              <%= form.label :body, 'Add a comment', class: 'form-label' %>
              <%= form.text_area :body, class: 'form-textarea', rows: 2, placeholder: 'Add a clarifying comment...' %>
            </div>
            <div class="form-actions">
              <%= form.submit 'Comment', class: 'form-secondary-button' %>
            </div>
          <% end %>
        </div>

        <% if answer.answer_revisions.any? %>
          <div class="revision-history answer-revisions">
            <details>
              <summary>Answer edit history (<%= answer.answer_revisions.count %>)</summary>
              <ul>
                <% answer.answer_revisions.order(created_at: :desc).each do |revision| %>
                  <li>
                    <div class="revision-meta">
                      <span class="revision-author"><%= display_author(revision.user, context: answer) %></span>
                      <span class="revision-time"><%= time_ago_in_words(revision.created_at) %> ago</span>
                    </div>
                    <p><%= simple_format(revision.body) %></p>
                  </li>
                <% end %>
              </ul>
            </details>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @post.post_revisions.any? %>
    <hr class="section-divider">
    <%= render 'revision_history', post: @post %>
  <% end %>
</div>
