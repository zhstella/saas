<%# 
  !! -------------------------------- !!
  !!      è¿™æ˜¯ã€å·²ä¿®å¤ã€‘çš„ show.html.erb     !!
  !!  (ä½¿ç”¨ Stimulus Controller)       !!
  !! -------------------------------- !!
%>

<%# 
  !! æ›´æ”¹ 1: 
     æˆ‘ä»¬åœ¨è¿™é‡Œ "è¿žæŽ¥" (connect) äº†æ–°çš„ controller
%>
<div class="main-content-container" data-controller="post-show">

  <%# --- 1. å¸–å­å†…å®¹ --- %>
  <h2 class="page-title"><%= @post.title %></h2>
  <div class="post-meta">
    <span class="post-author">
      Posted by: 
      <% if @post.user == current_user %>
        <strong>You</strong>
      <% else %>
        <%= @post.user.email %>
      <% end %>
    </span>
    <span class="post-time"><%= time_ago_in_words(@post.created_at) %> ago</span>
  </div>
  <div class="post-body">
    <%= @post.body %>
  </div>

  <%# --- 2. å¸–å­æ“ä½œ (Like / Delete) --- %>
  <div class="post-actions">
    
    <div class="post-actions-left">
      <%= link_to "Like (ðŸ‘ 0)", "#", class: "form-cancel-button" %>

      <%# 
        !! æ›´æ”¹ 2: 
           (a) æˆ‘ä»¬åˆ é™¤äº†æ—§çš„ 'id'
           (b) æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª 'data-action'
           è¿™ä¼šå‘Šè¯‰ Stimulus:
           "å½“è¿™ä¸ªæŒ‰é’®è¢« 'click' æ—¶, 
            è°ƒç”¨ 'post-show' controller ä¸Šçš„ 'toggleCommentForm' å‡½æ•°"
      %>
      <%= link_to "Comments (#{ @post.comments.count })", "#", 
                  class: "form-cancel-button",
                  data: { action: "click->post-show#toggleCommentForm" } %>
    </div>

    <% if @post.user == current_user %>
      <%= button_to "Delete This Post", @post, 
                  method: :delete, 
                  class: "btn-destructive",
                  data: { turbo_confirm: "Are you sure..." } %>
    <% end %>
  </div>
  
  <hr class="section-divider">

  <%# 
    !! æ›´æ”¹ 3: 
       (a) æˆ‘ä»¬åˆ é™¤äº†æ—§çš„ 'id'
       (b) æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª 'data-post-show-target'
       è¿™ä¼šå‘Šè¯‰ Stimulus: 
       "è¿™ä¸ª div å°±æ˜¯ä½ æ­£åœ¨å¯»æ‰¾çš„ 'commentForm' ç›®æ ‡"
  %>
  <div data-post-show-target="commentForm">
    
    <%# --- 3. æ–°è¯„è®ºè¡¨å• (çŽ°åœ¨åœ¨ Wrapper å†…éƒ¨) --- %>
    <h3 class="comments-title">Add Your Comment</h3>
    
    <%= form_with(model: [@post, @comment]) do |form| %>
      <div class="form-field">
        <%= form.label :body, "Comment Content", class: "form-label" %>
        <%= form.text_area :body, class: "form-textarea", rows: 4, placeholder: "Type your comment here..." %>
      </div>
      <div class="form-actions">
        <%= form.submit "Submit Comment", class: "form-submit-button" %>
      </div>
    <% end %>

    <hr class="section-divider">
  </div>

  <%# --- 4. è¯„è®ºåˆ—è¡¨ --- %>
  <h3 class="comments-title">Comments (<%= @post.comments.count %>)</h3>

  <div class="comments-list-container">
    <% @post.comments.each do |comment| %>
      <div class="comment-card">

        <%# è¯„è®ºä½œè€…å’Œæ—¶é—´ %>
        <div class="comment-meta">
          <span class="comment-author">
            <% if comment.user == current_user %>
              <strong>You</strong>
            <% else %>
              <%= comment.user.email %>
            <% end %>
          </span>
          <span class="comment-time"><%= time_ago_in_words(comment.created_at) %> ago</span>
        </div>

        <%# è¯„è®ºæ­£æ–‡ %>
        <div class="comment-body">
          <%= comment.body %>
        </div>

        <%# åˆ é™¤è¯„è®ºçš„é“¾æŽ¥ %>
        <% if comment.user == current_user %>
          <div class="comment-actions">
            <%= button_to "Delete Comment", [@post, comment], 
                        method: :delete, 
                        class: "comment-delete-link",
                        data: { turbo_confirm: "Are you sure?" } %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>