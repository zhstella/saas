<%# 
  !! -------------------------------- !!
  !!      ËøôÊòØ„ÄêÂ∑≤‰øÆÂ§ç„ÄëÁöÑ show.html.erb     !!
  !!  (‰ΩøÁî® Stimulus Controller)       !!
  !! -------------------------------- !!
%>

<%# 
  !! Êõ¥Êîπ 1: 
     Êàë‰ª¨Âú®ËøôÈáå "ËøûÊé•" (connect) ‰∫ÜÊñ∞ÁöÑ controller
%>
<div class="main-content-container" data-controller="post-show">

  <%# --- 1. Â∏ñÂ≠êÂÜÖÂÆπ --- %>
  <h2 class="page-title"><%= @post.title %></h2>
  <div class="post-meta">
    <span class="post-author">
      Posted by: <strong><%= display_author(@post.user, context: @post) %></strong>
    </span>
    <span class="post-time"><%= time_ago_in_words(@post.created_at) %> ago</span>
  </div>

  <% if @post.expires_at.present? %>
    <p class="identity-badge">Expires <%= time_ago_in_words(@post.expires_at) %> from now</p>
  <% end %>

  <% if current_user == @post.user && !@post.show_real_identity? %>
    <div class="identity-controls">
      <%= button_to "Reveal My Identity", 
                    reveal_identity_post_path(@post), 
                    method: :patch, 
                    class: "form-submit-button identity-button", 
                    data: { turbo_confirm: "Reveal your real identity on this thread?" } %>
    </div>
  <% elsif @post.show_real_identity? %>
    <p class="identity-badge">Author chose to reveal their identity.</p>
  <% end %>
  <div class="post-body">
    <%= @post.body %>
  </div>

  <%# --- 2. Â∏ñÂ≠êÊìç‰Ωú (Like / Delete) --- %>
  <div class="post-actions">
    
    <div class="post-actions-left">
      <% if user_signed_in? %>
        <% if @post.liked_by?(current_user) %>
          <%= button_to "Unlike (üëç #{@post.likes.count})", 
                        post_like_path(@post, @post.find_like_by(current_user)), 
                        method: :delete, 
                        class: "form-cancel-button" %>
        <% else %>
          <%= button_to "Like (üëç #{@post.likes.count})", 
                        post_likes_path(@post), 
                        method: :post, 
                        class: "form-cancel-button" %>
        <% end %>
      <% else %>
        <span class="form-cancel-button disabled">üëç <%= @post.likes.count %></span>
      <% end %>

      <%= link_to "Comments (#{ @post.comments.count })", "#", 
                  class: "form-cancel-button",
                  data: { action: "click->post-show#toggleCommentForm" } %>
    </div>

    <% if @post.user == current_user %>
      <%= button_to "Delete This Post", @post, 
                  method: :delete, 
                  class: "btn-destructive",
                  data: { turbo_confirm: "Are you sure..." } %>
    <% end %>
  </div>
  
  <hr class="section-divider">

  <%# 
    !! Êõ¥Êîπ 3: 
       (a) Êàë‰ª¨Âà†Èô§‰∫ÜÊóßÁöÑ 'id'
       (b) Êàë‰ª¨Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™ 'data-post-show-target'
       Ëøô‰ºöÂëäËØâ Stimulus: 
       "Ëøô‰∏™ div Â∞±ÊòØ‰Ω†Ê≠£Âú®ÂØªÊâæÁöÑ 'commentForm' ÁõÆÊ†á"
  %>
  <div data-post-show-target="commentForm">
    
    <%# --- 3. Êñ∞ËØÑËÆ∫Ë°®Âçï (Áé∞Âú®Âú® Wrapper ÂÜÖÈÉ®) --- %>
    <h3 class="comments-title">Add Your Comment</h3>
    
    <%= form_with(model: [@post, @comment]) do |form| %>
      <% if @comment.errors.any? %>
        <div class="form-errors">
          <% @comment.errors.full_messages.each do |message| %>
            <p class="error-message"><%= message %></p>
          <% end %>
        </div>
      <% end %>
      <div class="form-field">
        <%= form.label :body, "Comment Content", class: "form-label" %>
        <%= form.text_area :body, class: "form-textarea", rows: 4, placeholder: "Type your comment here..." %>
      </div>
      <div class="form-actions">
        <%= form.submit "Submit Comment", class: "form-submit-button" %>
      </div>
    <% end %>

    <hr class="section-divider">
  </div>

  <%# --- 4. ËØÑËÆ∫ÂàóË°® --- %>
  <h3 class="comments-title">Comments (<%= @post.comments.count %>)</h3>

  <div class="comments-list-container" id="comments">
    <% @post.comments.each do |comment| %>
      <% next unless comment.persisted? %>
      <div class="comment-card">

        <%# ËØÑËÆ∫‰ΩúËÄÖÂíåÊó∂Èó¥ %>
        <div class="comment-meta">
          <span class="comment-author">
            <strong><%= display_author(comment.user, context: comment) %></strong>
          </span>
          <span class="comment-time">
            <% if comment.created_at.present? %>
              <%= time_ago_in_words(comment.created_at) %> ago
            <% else %>
              just now
            <% end %>
          </span>
        </div>

        <%# ËØÑËÆ∫Ê≠£Êñá %>
        <div class="comment-body">
          <%= comment.body %>
        </div>

        <%# Âà†Èô§ËØÑËÆ∫ÁöÑÈìæÊé• %>
        <% if comment.user == current_user %>
          <div class="comment-actions">
            <%= button_to "Delete Comment", [@post, comment], 
                        method: :delete, 
                        class: "comment-delete-link",
                        data: { turbo_confirm: "Are you sure?" } %>
            <% unless comment.show_real_identity? %>
              <%= button_to "Reveal My Identity", 
                            reveal_identity_post_comment_path(@post, comment), 
                            method: :patch, 
                            class: "comment-reveal-button", 
                            data: { turbo_confirm: "Reveal your identity on this comment?" } %>
            <% end %>
          </div>
          <% if comment.show_real_identity? %>
            <span class="identity-badge">Commenter revealed their identity.</span>
          <% end %>
        <% elsif comment.show_real_identity? %>
          <span class="identity-badge">Commenter revealed their identity.</span>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
